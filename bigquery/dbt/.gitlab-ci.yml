stages:
  - build
  - test
  - deploy
  
image: registry.gitlab.com/gitlab-data/data-image/dbt-image:v0.0.15

before_script:
  - export GCP_JSON_KEY=$GCP_JSON_KEY
  - export CI_PROFILE_TARGET="--profiles-dir profile --target dev"
  - export PROD_PROFILE_TARGET="--profiles-dir profile --target prod"
  - echo $CI_PROFILE_TARGET
  - echo $PROD_PROFILE_TARGET

after_script:
  - echo "â„ï¸OKâ„ï¸"

build1 âš™ï¸:
  stage: build
  script:
    - echo "â„ï¸install all packagesâ„ï¸"
    - pip install -r requirements.txt

test1 ğŸ¦–:
  stage: test
  script:
    - echo "â„ï¸connection testâ„ï¸"
    - dbt debug $CI_PROFILE_TARGET

test2 ğŸ­:
  stage: test
  needs: [test1 ğŸ¦–]
  script:
    - echo "â„ï¸config testâ„ï¸"
    - dbt test $CI_PROFILE_TARGET

dev deploy âš¡:
  stage: deploy
  script:
    - echo "â„ï¸ deploy to development â„ï¸"
    - dbt run $CI_PROFILE_TARGET
  when: manual

prod deploy ğŸš€:
  stage: deploy
  script:
    - echo "â„ï¸ deploy to production â„ï¸"
    - dbt seed $PROD_PROFILE_TARGET
    - dbt run $PROD_PROFILE_TARGET
  when: manual
